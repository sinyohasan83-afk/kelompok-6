<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Buku Tamu Online</title>
    <style>
        :root {
            --color-primary: #00f2ff;
            --color-secondary: #0066ff;
            --color-accent: #ff00ff;
            --color-bg-dark: #0a0e27;
            --color-bg-card: #141b3d;
            --color-text: #ffffff;
            --color-text-muted: #8892b0;
            --color-success: #00ff88;
            --color-error: #ff3366;
            --color-warning: #ffaa00;
            --color-info: #00aaff; /* New color for completed/info */
        }

        /* LIGHT THEME VARIABLES */
        body.light-theme {
            --color-primary: #007bff; /* Bright Blue */
            --color-secondary: #6c757d; /* Gray */
            --color-accent: #dc3545; /* Red */
            --color-bg-dark: #f0f4f8; /* Very Light Background */
            --color-bg-card: #ffffff; /* White Card */
            --color-text: #212529; /* Dark Text */
            --color-text-muted: #6c757d; /* Gray Muted Text */
            --color-info: #17a2b8; /* Light theme info color */
        }
        
        /* Light Theme Adjustments */
        body.light-theme {
            background: linear-gradient(135deg, var(--color-bg-dark) 0%, #d8e2ed 100%);
            color: var(--color-text);
        }

        body.light-theme .header {
            background: rgba(255, 255, 255, 0.9);
            border-bottom-color: rgba(0, 123, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .logo {
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
        }
        
        body.light-theme .menu-toggle {
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
        }

        body.light-theme .menu-toggle span {
            background: #ffffff;
        }

        body.light-theme .nav-menu {
            background: rgba(255, 255, 255, 0.95);
            border-left: 2px solid rgba(0, 123, 255, 0.3);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .nav-item {
            background: rgba(240, 244, 248, 0.6);
            border: 2px solid rgba(0, 123, 255, 0.3);
            color: var(--color-text);
        }

        body.light-theme .nav-item:hover {
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.2);
        }

        body.light-theme .nav-item::before {
            background: linear-gradient(90deg, transparent, rgba(0, 123, 255, 0.2), transparent);
        }
        
        body.light-theme .card,
        body.light-theme .modal-content {
            background: var(--color-bg-card);
            border: 1px solid rgba(0, 123, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .form-control {
            background: #f8f9fa;
            border: 2px solid #ced4da;
            color: var(--color-text);
        }

        body.light-theme .form-control:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
            background: #ffffff;
        }

        body.light-theme .table thead {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 102, 255, 0.1));
        }
        
        body.light-theme .table th {
            color: var(--color-primary);
            border-bottom: 2px solid rgba(0, 123, 255, 0.3);
        }

        body.light-theme .table td {
            color: var(--color-text);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        body.light-theme .table tbody tr:hover {
            background: rgba(0, 123, 255, 0.05);
        }

        body.light-theme .stat-card {
            background: rgba(0, 123, 255, 0.05);
            border: 1px solid rgba(0, 123, 255, 0.3);
        }

        body.light-theme .stat-card:hover {
            box-shadow: 0 8px 30px rgba(0, 123, 255, 0.2);
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: var(--color-text);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }
        
        .bg-circle {
            position: absolute;
            background: radial-gradient(circle, rgba(0, 242, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            animation: float 21s infinite cubic-bezier(0.6, 0.0, 0.4, 1.0);
        }

        .bg-circle:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }

        .bg-circle:nth-child(2) {
            width: 200px;
            height: 200px;
            top: 50%;
            right: -100px;
            animation-delay: 7s;
            background: radial-gradient(circle, rgba(255, 0, 255, 0.1) 0%, transparent 70%);
        }

        .bg-circle:nth-child(3) {
            width: 250px;
            height: 250px;
            bottom: -125px;
            left: 50%;
            animation-delay: 14s;
            background: radial-gradient(circle, rgba(0, 102, 255, 0.1) 0%, transparent 70%);
        }
        
        /* Light mode turns off the heavy background animation circles */
        body.light-theme .bg-circle {
            background: radial-gradient(circle, rgba(0, 123, 255, 0.05) 0%, transparent 70%);
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(50px, -50px) scale(1.1);
            }
            66% {
                transform: translate(-30px, 30px) scale(0.9);
            }
        }

        /* Header */
        .header {
            background: rgba(20, 27, 61, 0.8);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            border-bottom: 2px solid rgba(0, 242, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 242, 255, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 242, 255, 0.5);
        }

        .user-info {
            display: none;
        }

        /* Hamburger Menu Button */
        .menu-toggle {
            position: absolute;
            top: 50%;
            right: 2rem;
            transform: translateY(-50%);
            z-index: 1011;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 20px rgba(0, 242, 255, 0.4);
            transition: all 0.3s ease;
        }

        .menu-toggle:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 30px rgba(0, 242, 255, 0.6);
        }

        .menu-toggle span {
            width: 25px;
            height: 3px;
            background: var(--color-bg-dark);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        body.light-theme .menu-toggle span {
            background: var(--color-bg-dark); /* Ensure dark color for lines in light mode toggle */
        }

        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        /* Navigation Menu */
        .nav-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: rgba(20, 27, 61, 0.95);
            border-left: 2px solid rgba(0, 242, 255, 0.3);
            z-index: 1010;
            padding: 80px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .nav-menu.active {
            right: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(10, 14, 39, 0.6);
            border: 2px solid rgba(0, 242, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            color: var(--color-text);
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 242, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
            transform: translateX(-5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.2), rgba(0, 102, 255, 0.2));
            border-color: var(--color-primary);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.4);
        }
           
        /* Logout Button Style within Nav */
        .nav-item.nav-logout {
            margin-top: auto;
            background: rgba(255, 51, 102, 0.2);
            border-color: var(--color-error);
        }

        .nav-item.nav-logout:hover {
            border-color: var(--color-error);
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.5);
            transform: translateX(-5px);
        }

        .nav-item.nav-logout::before {
            background: linear-gradient(90deg, transparent, rgba(255, 51, 102, 0.3), transparent);
        }

        .nav-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        .nav-text {
            flex: 1;
            text-align: left;
        }

        /* Menu Overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
           
        /* Kontainer untuk efek blur saat menu aktif */
        #mainContentWrapper {
            transition: filter 0.4s ease;
        }

        /* Kelas untuk mengaplikasikan blur pada konten utama */
        .content-blurred #mainContentWrapper {
            filter: blur(8px);
            pointer-events: none;
        }
           
        /* Perbaikan: Atur z-index untuk semua tombol/menu toggle */
        .menu-toggle {
            z-index: 1011;
        }

        /* Card */
        .card {
            background: rgba(20, 27, 61, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 242, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 242, 255, 0.2);
            border-color: var(--color-primary);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--color-primary), var(--color-accent));
            border-radius: 2px;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(10, 14, 39, 0.6);
            border: 2px solid rgba(0, 242, 255, 0.3);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
            background: rgba(10, 14, 39, 0.8);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Button */
        .btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-bg-dark);
            box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 25px rgba(0, 242, 255, 0.5);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(136, 146, 176, 0.2);
            color: var(--color-text);
            border: 2px solid rgba(136, 146, 176, 0.3);
        }
        
        body.light-theme .btn-secondary {
            color: var(--color-text);
            border: 2px solid #ced4da;
            background: #e9ecef;
        }

        .btn-secondary:hover {
            background: rgba(136, 146, 176, 0.3);
            border-color: rgba(136, 146, 176, 0.5);
        }
        
        body.light-theme .btn-secondary:hover {
            background: #f8f9fa;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-error), #cc0044);
            color: var(--color-text);
        }
        
        body.light-theme .btn-danger {
            color: #ffffff;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--color-success), #00cc66);
            color: var(--color-bg-dark);
        }
        
        /* New button style for marking as complete */
        .btn-info {
            background: linear-gradient(135deg, var(--color-info), #007799);
            color: var(--color-bg-dark);
        }
        
        body.light-theme .btn-info {
            color: #ffffff;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            background: rgba(10, 14, 39, 0.4);
        }
        
        body.light-theme .table-container {
            background: rgba(0, 123, 255, 0.05);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.2), rgba(0, 102, 255, 0.2));
        }

        .table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--color-primary);
            border-bottom: 2px solid rgba(0, 242, 255, 0.3);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(136, 146, 176, 0.1);
            color: var(--color-text);
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background: rgba(0, 242, 255, 0.05);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-admin {
            background: linear-gradient(135deg, var(--color-accent), #cc00cc);
            color: var(--color-text);
        }

        .badge-user {
            background: linear-gradient(135deg, var(--color-secondary), #0044cc);
            color: var(--color-text);
        }

        .badge-pending {
            background: rgba(255, 170, 0, 0.2);
            color: var(--color-warning);
            border: 1px solid var(--color-warning);
        }

        .badge-approved {
            background: rgba(0, 255, 136, 0.2);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }
        
        /* New badge style for completed status */
        .badge-completed {
            background: rgba(0, 170, 255, 0.2);
            color: var(--color-info);
            border: 1px solid var(--color-info);
        }

        /* Search & Filter */
        .search-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .filter-select {
            min-width: 150px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.1), rgba(0, 102, 255, 0.1));
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(0, 242, 255, 0.3);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 242, 255, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--color-text-muted);
            margin-top: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-bg-card);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid rgba(0, 242, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 242, 255, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        body.light-theme .modal-content {
            border: 2px solid rgba(0, 123, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        body.light-theme .close-modal {
            color: var(--color-text);
        }

        .close-modal:hover {
            background: rgba(255, 51, 102, 0.2);
            color: var(--color-error);
        }

        /* Alert */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 1rem;
            animation: slideDown 0.3s ease;
        }

        .alert.show {
            display: flex;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--color-success);
            color: var(--color-success);
        }

        .alert-error {
            background: rgba(255, 51, 102, 0.2);
            border: 1px solid var(--color-error);
            color: var(--color-error);
        }

        .alert-info {
            background: rgba(0, 242, 255, 0.2);
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
        }

        /* Action Buttons */
        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* Export Buttons */
        .export-btns {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .menu-toggle {
                right: 1rem;
                width: 45px;
                height: 45px;
            }
           
            .user-info {
                display: none;
            }
           
            .logo {
                font-size: 1.5rem;
            }

            .nav-menu {
                width: 280px;
                right: -300px;
            }

            .search-filter {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                font-size: 0.9rem;
            }

            .action-btns {
                flex-direction: column;
            }
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .login-card {
            max-width: 450px;
            width: 100%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-title {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--color-text-muted);
        }
        
        /* --- MODE TOGGLE SWITCH CSS --- */
        .theme-switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: default;
            margin-bottom: 1rem;
        }
        
        /* Remove hover effects for the container itself */
        .theme-switch-container:hover {
            box-shadow: none;
            border-color: rgba(0, 0, 0, 0.1);
            transform: none;
            background: rgba(10, 14, 39, 0.6);
        }
        
        body.light-theme .theme-switch-container:hover {
             background: rgba(240, 244, 248, 0.6);
        }
        
        .theme-switch-container .nav-text {
             flex: none;
        }

        /* The switch - the box around the slider */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        /* Dark Mode colors (Default) */
        .slider {
            background-color: #555; /* Dark grey when unchecked */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23555' d='M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8ZM12 6a6 6 0 0 0 0 12 6 6 0 0 0 0-12Z'/%3E%3C/svg%3E"); /* Moon icon */
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
        }

        input:checked + .slider {
            background-color: var(--color-primary); /* Primary color when checked (Light Mode) */
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--color-primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23F0B429' d='M12 2.25A9.75 9.75 0 0 0 2.25 12 9.75 9.75 0 0 0 12 21.75c3.24 0 6.13-1.63 7.84-4.13A.75.75 0 0 0 19 17v-2.14a8.91 8.91 0 0 1-7 .42 8.27 8.27 0 0 1-6.1-2.95 8.1 8.1 0 0 1-1.35-8.8 9.77 9.77 0 0 0 8.44-1.78Z'/%3E%3C/svg%3E"); /* Sun icon */
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* END MODE TOGGLE SWITCH CSS */
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>

    <div id="loginPage" class="login-container">
        <div class="card login-card">
            <div class="login-header">
                <h1 class="login-title">Buku Tamu Online</h1>
                <p class="login-subtitle">Sistem Manajemen Tamu Digital</p>
            </div>

            <div id="loginAlert" class="alert"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Identitas</label>
                    <!-- Perubahan: type="email" diubah menjadi type="text" -->
                    <input type="text" class="form-control" id="loginEmail" required placeholder="admin@buku.com / user@buku.com">
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required placeholder="admin123 / user123">
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                    Login
                </button>

                <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="showRegisterForm()">
                    Daftar Akun Baru
                </button>
            </form>

            <div style="margin-top: 1.5rem; text-align: center; color: var(--color-text-muted); font-size: 0.9rem;">
                <p><strong>Desain by Kelompok 6</strong></p>
                <p><strong>Nurhasan, Fariz Nurrahim, Aprien Febrian</strong></p>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Registrasi Akun Baru</h2>
                <button class="close-modal" onclick="closeRegisterModal()">&times;</button>
            </div>

            <div id="registerAlert" class="alert"></div>

            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">Nama Lengkap</label>
                    <input type="text" class="form-control" id="regName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Identitas</label>
                    <!-- Perubahan: type="email" diubah menjadi type="text" -->
                    <input type="text" class="form-control" id="regEmail" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="regPassword" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Nomor Telepon</label>
                    <input type="tel" class="form-control" id="regPhone" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Alamat</label>
                    <textarea class="form-control" id="regAddress" required></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Daftar
                </button>
            </form>
        </div>
    </div>

    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
   
    <div id="mainContentWrapper">
        <div id="mainApp" style="display: none;">
            <header class="header">
                <div class="container">
                    <div class="header-content">
                        <div class="logo">üìñ Buku Tamu Online</div>
                       
                        <button class="menu-toggle" onclick="toggleMenu()">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                       
                    </div>
                </div>
            </header>

            <div class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
                <div id="mainAlert" class="alert"></div>

                <div id="dashboard" class="section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalEntries">0</div>
                            <div class="stat-label">Total Tamu Masuk</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">Total User</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingEntries">0</div>
                            <div class="stat-label">Menunggu Approval</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="todayEntries">0</div>
                            <div class="stat-label">Tamu Hari Ini</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">Entri Terbaru</h2>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Nama</th>
                                        <th>Institusi</th>
                                        <th>Keperluan</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recentEntriesTable">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--color-text-muted);">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="guestbook" class="section">
                    <div class="card">
                        <h2 class="card-title">Tambah Entri Baru</h2>
                        <form id="guestbookForm">
                            <div class="form-group">
                                <label class="form-label">Nama Tamu</label>
                                <input type="text" class="form-control" id="guestName" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Identitas</label>
                                <!-- Perubahan: type="email" diubah menjadi type="text" -->
                                <input type="text" class="form-control" id="guestEmail" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nomor Telepon</label>
                                <input type="tel" class="form-control" id="guestPhone" required>
                            </div>
                            
                            <!-- START: Kolom Jumlah Tamu Baru -->
                            <div class="form-group">
                                <label class="form-label">Jumlah Tamu</label>
                                <input type="number" class="form-control" id="guestCount" required value="1" min="1">
                            </div>
                            <!-- END: Kolom Jumlah Tamu Baru -->

                            <div class="form-group">
                                <label class="form-label">Institusi/Perusahaan</label>
                                <input type="text" class="form-control" id="guestInstitution" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Keperluan</label>
                                <textarea class="form-control" id="guestPurpose" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Bertemu Dengan</label>
                                <input type="text" class="form-control" id="guestMeetWith" required>
                            </div>

                            <button type="submit" class="btn btn-primary">Simpan Entri</button>
                            <button type="reset" class="btn btn-secondary">Reset</button>
                        </form>
                    </div>
                </div>

                <div id="allEntries" class="section">
                    <div class="card">
                        <h2 class="card-title">Semua Entri Buku Tamu</h2>
                       
                        <div class="export-btns">
                            <button class="btn btn-success btn-sm" onclick="exportToCSV()">üìä Export CSV</button>
                            <button class="btn btn-success btn-sm" onclick="exportToPDF()">üìÑ Export PDF</button>
                            <button class="btn btn-primary btn-sm" onclick="printEntries()">üñ®Ô∏è Print</button>
                        </div>

                        <div class="search-filter">
                            <div class="search-box">
                                <input type="text" class="form-control" id="searchEntries" placeholder="üîç Cari nama, institusi, atau keperluan...">
                            </div>
                            <select class="form-control filter-select" id="filterStatus">
                                <option value="">Semua Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="completed">Selesai</option> <!-- Tambah opsi Selesai -->
                            </select>
                            <select class="form-control filter-select" id="filterDate">
                                <option value="">Semua Tanggal</option>
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                            </select>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Nama</th>
                                        <th>Identitas</th>
                                        <!-- START: Kolom Jumlah Tamu Baru -->
                                        <th>Jumlah Tamu</th>
                                        <!-- END: Kolom Jumlah Tamu Baru -->
                                        <th>Institusi</th>
                                        <th>Keperluan</th>
                                        <th>Bertemu</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTable">
                                    <tr>
                                        <td colspan="9" style="text-align: center; color: var(--color-text-muted);">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <div id="myEntries" class="section">
                    <div class="card">
                        <h2 class="card-title">Entri Saya</h2>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Nama Tamu</th>
                                        <th>Institusi</th>
                                        <th>Keperluan</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="myEntriesTable">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: var(--color-text-muted);">Memuat data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="users" class="section">
                    <div class="card">
                        <h2 class="card-title">Kelola User</h2>
                       
                        <div class="search-filter">
                            <div class="search-box">
                                <input type="text" class="form-control" id="searchUsers" placeholder="üîç Cari nama atau identitas...">
                            </div>
                            <select class="form-control filter-select" id="filterRole">
                                <option value="">Semua Role</option>
                                <option value="admin">Admin</option>
                                <option value="user">User</option>
                            </select>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Nama</th>
                                        <th>Identitas</th>
                                        <th>Telepon</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="settings" class="section">
                    <div class="card">
                        <h2 class="card-title">Pengaturan Profil</h2>
                        <form id="profileForm">
                            <div class="form-group">
                                <label class="form-label">Nama Lengkap</label>
                                <input type="text" class="form-control" id="profileName" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Identitas</label>
                                <!-- Perubahan: type="email" diubah menjadi type="text" -->
                                <input type="text" class="form-control" id="profileEmail" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nomor Telepon</label>
                                <input type="tel" class="form-control" id="profilePhone" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Alamat</label>
                                <textarea class="form-control" id="profileAddress"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                        </form>
                    </div>

                    <div class="card">
                        <h2 class="card-title">Ubah Password</h2>
                        <form id="passwordForm">
                            <div class="form-group">
                                <label class="form-label">Password Lama</label>
                                <input type="password" class="form-control" id="oldPassword" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Password Baru</label>
                                <input type="password" class="form-control" id="newPassword" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Konfirmasi Password Baru</label>
                                <input type="password" class="form-control" id="confirmPassword" required>
                            </div>

                            <button type="submit" class="btn btn-primary">Ubah Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
   
    <nav class="nav-menu" id="navMenu">
        <div style="margin-bottom: 1rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(0, 242, 255, 0.2);">
            <div class="user-info" style="gap: 0.75rem; justify-content: flex-start; display: flex !important;">
                <div class="user-avatar" id="navUserAvatar" style="width: 50px; height: 50px; font-size: 1.5rem;">A</div>
                <div>
                    <div id="navUserName" style="font-weight: 700; font-size: 1.1rem;">User Name</div>
                    <div id="navUserRole" style="font-size: 0.9rem; color: var(--color-primary);">Role</div>
                </div>
            </div>
        </div>
        
        <!-- MODE TOGGLE SWITCH -->
        <div class="nav-item theme-switch-container">
            <span class="nav-text" id="themeLabel">Mode Gelap</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider round"></span>
            </label>
        </div>
        <!-- END MODE TOGGLE -->

        <button class="nav-item active" onclick="navigateTo('dashboard', this)">
            <span class="nav-icon">üìä</span>
            <span class="nav-text">Dashboard</span>
        </button>
        <button class="nav-item" onclick="navigateTo('guestbook', this)">
            <span class="nav-icon">üìù</span>
            <span class="nav-text">Entri Baru</span>
        </button>
        <button class="nav-item" onclick="navigateTo('myEntries', this)">
            <span class="nav-icon">üëÄ</span>
            <span class="nav-text">Entri Saya</span>
        </button>
        <button class="nav-item" onclick="navigateTo('allEntries', this)">
            <span class="nav-icon">üìñ</span>
            <span class="nav-text">Semua Entri</span>
        </button>
        <button class="nav-item" id="usersMenuItem" onclick="navigateTo('users', this)" style="display: none;">
            <span class="nav-icon">üë•</span>
            <span class="nav-text">Kelola User</span>
        </button>
        <button class="nav-item" onclick="navigateTo('settings', this)">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-text">Pengaturan</span>
        </button>
       
        <button class="nav-item nav-logout" onclick="logout()">
            <span class="nav-icon">üö™</span>
            <span class="nav-text">Logout</span>
        </button>
    </nav>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detail Entri</h2>
                <button class="close-modal" onclick="closeViewModal()">&times;</button>
            </div>
            <div id="viewModalContent"></div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Entri</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editEntryId">
                <div class="form-group">
                    <label class="form-label">Nama Tamu</label>
                    <input type="text" class="form-control" id="editGuestName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Identitas</label>
                    <!-- Perubahan: type="email" diubah menjadi type="text" -->
                    <input type="text" class="form-control" id="editGuestEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nomor Telepon</label>
                    <input type="tel" class="form-control" id="editGuestPhone" required>
                </div>
                <!-- START: Kolom Jumlah Tamu Baru (Edit) -->
                <div class="form-group">
                    <label class="form-label">Jumlah Tamu</label>
                    <input type="number" class="form-control" id="editGuestCount" required value="1" min="1">
                </div>
                <!-- END: Kolom Jumlah Tamu Baru (Edit) -->
                <div class="form-group">
                    <label class="form-label">Institusi</label>
                    <input type="text" class="form-control" id="editGuestInstitution" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Keperluan</label>
                    <textarea type="text" class="form-control" id="editGuestPurpose" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Bertemu Dengan</label>
                    <input type="text" class="form-control" id="editGuestMeetWith" required>
                </div>
                <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title" id="confirmTitle">Konfirmasi Aksi</h2>
                <button class="close-modal" onclick="closeConfirmationModal()">&times;</button>
            </div>
            <div id="confirmMessage" style="margin-bottom: 1.5rem; color: var(--color-text);"></div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeConfirmationModal()">Batal</button>
                <button class="btn btn-danger" id="confirmActionBtn">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <script>
        // Data in-memory (NON-PERSISTENT/HILANG SAAT REFRESH UNTUK HOSTING STATIS)
        let currentUser = null;
        let users = [
            { id: 1, name: 'Administrator', email: 'admin@buku.com', password: 'admin123', phone: '081234567890', address: 'Jakarta', role: 'admin', status: 'active' },
            { id: 2, name: 'User Demo', email: 'user@buku.com', password: 'user123', phone: '081234567891', address: 'Bandung', role: 'user', status: 'active' }
        ];

        let guestbookEntries = [];
        let nextEntryId = 1;
        let nextUserId = 3;

        // Custom Confirmation Modal Logic
        let confirmCallback = null;

        function showConfirmationModal(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            const actionBtn = document.getElementById('confirmActionBtn');
            
            let btnClass = 'btn-primary';
            if (title.includes('Hapus') || title.includes('Logout') || title.includes('Nonaktifkan')) {
                btnClass = 'btn-danger';
            } else if (title.includes('Approve') || title.includes('Aktifkan')) {
                btnClass = 'btn-success';
            } else if (title.includes('Selesai')) { // Tombol Selesai
                btnClass = 'btn-info';
            }
            
            actionBtn.className = 'btn ' + btnClass;
            actionBtn.textContent = title.includes('Hapus') ? 'Ya, Hapus' : (title.includes('Nonaktifkan') ? 'Ya, Nonaktifkan' : (title.includes('Selesai') ? 'Ya, Selesai' : 'Ya, Lanjutkan'));
            document.getElementById('confirmationModal').classList.add('active');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('active');
            confirmCallback = null;
        }

        document.getElementById('confirmActionBtn').addEventListener('click', function() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmationModal();
        });

        // --- THEME TOGGLE LOGIC ---
        function toggleTheme() {
            const isChecked = document.getElementById('themeToggle').checked;
            const body = document.body;
            const themeLabel = document.getElementById('themeLabel');

            if (isChecked) {
                // Light Mode
                body.classList.add('light-theme');
                localStorage.setItem('themePreference', 'light');
                themeLabel.textContent = 'Mode Terang';
            } else {
                // Dark Mode
                body.classList.remove('light-theme');
                localStorage.setItem('themePreference', 'dark');
                themeLabel.textContent = 'Mode Gelap';
            }
        }
        
        // Listener for the toggle switch
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggleEl = document.getElementById('themeToggle');
            if(themeToggleEl) {
                themeToggleEl.addEventListener('change', toggleTheme);
            }
        });
        
        // --- END THEME TOGGLE LOGIC ---

        // Initialize and check session (uses localStorage for session only, not data)
        document.addEventListener('DOMContentLoaded', function() {
            // Memuat data entri dan user dari localStorage untuk DEMO PERSISTENSI ANTARA REFRESH
            // Hapus baris-baris ini jika Anda benar-benar tidak ingin menggunakan localStorage sama sekali.
            const initialGuestbook = JSON.parse(localStorage.getItem('initialGuestbook')) || [];
            if (initialGuestbook.length > 0) {
                guestbookEntries = initialGuestbook;
                nextEntryId = Math.max(...guestbookEntries.map(e => e.id), 0) + 1;
            }
            const savedUsers = JSON.parse(localStorage.getItem('savedUsers')) || [];
            if (savedUsers.length > 0) {
                 users = savedUsers;
                 nextUserId = Math.max(...users.map(u => u.id), 0) + 1;
            }

            // Theme initialization must happen before checking session to apply correct theme to login page
            const savedTheme = localStorage.getItem('themePreference');
            if (savedTheme === 'light') {
                document.getElementById('themeToggle').checked = true;
                document.body.classList.add('light-theme');
                document.getElementById('themeLabel').textContent = 'Mode Terang';
            } else {
                 // Default is dark mode, ensure checkbox is unchecked and class is removed if localStorage is corrupted
                document.getElementById('themeToggle').checked = false;
                document.body.classList.remove('light-theme');
                document.getElementById('themeLabel').textContent = 'Mode Gelap';
            }
            
            // Check if user is logged in (session only)
            const savedSession = localStorage.getItem('currentUserSession');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                const user = users.find(u => u.id === session.id);
                if (user) {
                    currentUser = user;
                    showMainApp();
                } else {
                    localStorage.removeItem('currentUserSession');
                }
            }
        });

        // --- MOCK API FUNCTIONS (RAM based) ---
        // Simulates fetching all data from a server with a slight delay
        async function fetchEntriesFromServer() {
            return new Promise(resolve => {
                setTimeout(() => {
                    const sortedEntries = guestbookEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                    resolve(sortedEntries);
                }, 10);
            });
        }

        // Simulates updating all data on the server
        async function updateEntryOnServer(newEntries) {
            return new Promise(resolve => {
                setTimeout(() => {
                    guestbookEntries = newEntries;
                    // Pastikan guestCount memiliki nilai default (1) jika tidak ada
                    guestbookEntries.forEach(e => {
                        if (typeof e.guestCount === 'undefined' || e.guestCount === null) {
                            e.guestCount = 1;
                        }
                    });
                    localStorage.setItem('initialGuestbook', JSON.stringify(guestbookEntries)); 
                    resolve(true);
                }, 10);
            });
        }
       
        // Simulates updating users array
        async function updateUsersOnServer() {
            return new Promise(resolve => {
                setTimeout(() => {
                    localStorage.setItem('savedUsers', JSON.stringify(users));
                    resolve(true);
                }, 10);
            });
        }
        // --- END MOCK API FUNCTIONS ---


        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // Note: input type is text now, but label is "Identitas"
            const email = document.getElementById('loginEmail').value; 
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.email === email && u.password === password);

            if (user && user.status === 'active') {
                currentUser = user;
                localStorage.setItem('currentUserSession', JSON.stringify({ id: user.id, role: user.role }));
               
                showAlert('loginAlert', 'Login berhasil! Mengalihkan...', 'success');
                setTimeout(() => {
                    showMainApp();
                }, 500);
            } else {
                showAlert('loginAlert', 'Identitas atau password salah, atau akun Anda belum aktif!', 'error');
            }
        });

        // Register
        function showRegisterForm() {
            document.getElementById('registerModal').classList.add('active');
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerForm').reset();
            document.getElementById('registerAlert').classList.remove('show');
        }

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newEmail = document.getElementById('regEmail').value;
            if (users.find(u => u.email === newEmail)) {
                showAlert('registerAlert', 'Identitas sudah terdaftar!', 'error');
                return;
            }
           
            const newUser = {
                id: nextUserId++,
                name: document.getElementById('regName').value,
                email: newEmail,
                password: document.getElementById('regPassword').value,
                phone: document.getElementById('regPhone').value,
                address: document.getElementById('regAddress').value,
                role: 'user',
                status: 'active'
            };

            users.push(newUser);
            await updateUsersOnServer();
            showAlert('registerAlert', 'Registrasi berhasil! Silakan login.', 'success');
           
            setTimeout(() => {
                closeRegisterModal();
            }, 1000);
        });

        // Logout
        function logout() {
            showConfirmationModal('Konfirmasi Logout', 'Yakin ingin logout dari sistem?', () => {
                currentUser = null;
                localStorage.removeItem('currentUserSession');
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('loginForm').reset();
                closeMenu();
            });
        }

        // Show Main App
        async function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Update nav user info
            document.getElementById('navUserName').textContent = currentUser.name;
            document.getElementById('navUserRole').textContent = currentUser.role === 'admin' ? 'Administrator' : 'User';
            document.getElementById('navUserAvatar').textContent = currentUser.name.charAt(0).toUpperCase();

            // Show/hide admin menu items
            document.getElementById('usersMenuItem').style.display = currentUser.role === 'admin' ? 'flex' : 'none';

            loadProfileData();

            // Load data views (Penting: harus dipanggil secara asinkron)
            await updateDashboard();
            await loadRecentEntries();
            await loadAllEntries();
            await loadMyEntries();
            await loadUsers();
           
            navigateTo('dashboard', document.querySelector('#navMenu .nav-item:nth-child(3)')); // Adjusted index due to new element
        }

        // Menu Toggle
        function toggleMenu() {
            const menuToggle = document.querySelector('.menu-toggle');
            const navMenu = document.getElementById('navMenu');
            const overlay = document.getElementById('menuOverlay');
           
            menuToggle.classList.toggle('active');
            navMenu.classList.toggle('active');
            overlay.classList.toggle('active');
           
            document.body.classList.toggle('content-blurred');
        }

        // Close Menu
        function closeMenu() {
            const menuToggle = document.querySelector('.menu-toggle');
            const navMenu = document.getElementById('navMenu');
            const overlay = document.getElementById('menuOverlay');
           
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
            overlay.classList.remove('active');
           
            document.body.classList.remove('content-blurred');
        }

        // Section Navigation
        function navigateTo(sectionId, targetElement) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
           
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
           
            if (targetElement) {
                // Ensure the active state is only set for non-toggle buttons
                if (!targetElement.classList.contains('theme-switch-container')) {
                     targetElement.classList.add('active');
                }
            } else {
                const defaultActive = document.querySelector(`.nav-menu button[onclick*="'${sectionId}'"]`);
                if (defaultActive) defaultActive.classList.add('active');
            }

            // Panggil pemuatan data ketika navigasi ke section tertentu
            if (sectionId === 'allEntries') loadAllEntries();
            if (sectionId === 'myEntries') loadMyEntries();
            if (sectionId === 'users' && currentUser.role === 'admin') loadUsers();

            closeMenu();
        }

        // Guestbook Form
        document.getElementById('guestbookForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const entry = {
                id: nextEntryId++,
                userId: currentUser.id,
                userName: currentUser.name,
                guestName: document.getElementById('guestName').value,
                // The field is labeled "Identitas" but stored as 'email'
                email: document.getElementById('guestEmail').value, 
                phone: document.getElementById('guestPhone').value,
                guestCount: parseInt(document.getElementById('guestCount').value) || 1, // Simpan Jumlah Tamu
                institution: document.getElementById('guestInstitution').value,
                purpose: document.getElementById('guestPurpose').value,
                meetWith: document.getElementById('guestMeetWith').value,
                date: new Date().toISOString(),
                status: currentUser.role === 'admin' ? 'approved' : 'pending'
            };
            
            // Validasi sederhana untuk Jumlah Tamu
            if (entry.guestCount < 1) {
                showAlert('mainAlert', 'Jumlah Tamu harus minimal 1.', 'error');
                return;
            }

            guestbookEntries.unshift(entry);
            await updateEntryOnServer(guestbookEntries);

            showAlert('mainAlert', 'Entri berhasil disimpan!' + (entry.status === 'pending' ? ' Menunggu approval Admin.' : ''), 'success');
            this.reset();
            document.getElementById('guestCount').value = 1; // Reset jumlah tamu ke 1

            await updateDashboard();
            await loadRecentEntries();
        });
       
        // Load All Entries
        async function loadAllEntries() {
            const tbody = document.getElementById('entriesTable');
            const allData = await fetchEntriesFromServer();
           
            const searchTerm = document.getElementById('searchEntries').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const dateFilter = document.getElementById('filterDate').value;

            let filtered = filterAndSearchEntries(allData, searchTerm, statusFilter, dateFilter);

            if (filtered.length === 0) {
                // Perluas colspan menjadi 9 (8 kolom data + 1 kolom Aksi)
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--color-text-muted);">Tidak ada entri</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(entry => {
                let actionButton = '';
                let statusLabel = '';
                
                if (entry.status === 'pending') {
                    statusLabel = `<span class="badge badge-pending">Pending</span>`;
                    if (currentUser.role === 'admin') {
                        actionButton = `<button class="btn btn-success btn-sm" onclick="approveEntry(${entry.id})">Approve</button>`;
                    }
                } else if (entry.status === 'approved') {
                    statusLabel = `<span class="badge badge-approved">Approved</span>`;
                    if (currentUser.role === 'admin') {
                        // Tombol untuk merubah status menjadi Selesai (completed)
                        actionButton = `<button class="btn btn-info btn-sm" onclick="completeEntry(${entry.id})">Tandai Selesai</button>`;
                    }
                } else if (entry.status === 'completed') {
                    statusLabel = `<span class="badge badge-completed">Selesai</span>`;
                }
                
                const commonButtons = `
                    <button class="btn btn-primary btn-sm" onclick="viewEntry(${entry.id})">Lihat</button>
                    ${currentUser.role === 'admin' || entry.userId === currentUser.id ? 
                        `<button class="btn btn-secondary btn-sm" onclick="editEntry(${entry.id})">Edit</button>
                         <button class="btn btn-danger btn-sm" onclick="deleteEntry(${entry.id})">Hapus</button>` : ''}
                `;
                
                return `
                    <tr>
                        <td>${formatDate(entry.date)}</td>
                        <td>${entry.guestName}</td>
                        <td>${entry.email}</td>
                        <td>${entry.guestCount || 1}</td> <!-- Tampilkan Jumlah Tamu -->
                        <td>${entry.institution}</td>
                        <td>${entry.purpose.substring(0, 50)}${entry.purpose.length > 50 ? '...' : ''}</td>
                        <td>${entry.meetWith}</td>
                        <td>${statusLabel}</td>
                        <td>
                            <div class="action-btns">
                                ${actionButton}
                                ${commonButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load My Entries (Tidak perlu Jumlah Tamu di sini, disesuaikan dengan skema tabel yang ada)
        async function loadMyEntries() {
            const tbody = document.getElementById('myEntriesTable');
            const allData = await fetchEntriesFromServer();
            const myEntries = allData.filter(e => e.userId === currentUser.id);

            if (myEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-text-muted);">Belum ada entri</td></tr>';
                return;
            }

            tbody.innerHTML = myEntries.map(entry => `
                <tr>
                    <td>${formatDate(entry.date)}</td>
                    <td>${entry.guestName}</td>
                    <td>${entry.institution}</td>
                    <td>${entry.purpose.substring(0, 50)}${entry.purpose.length > 50 ? '...' : ''}</td>
                    <td><span class="badge badge-${entry.status}">${entry.status === 'pending' ? 'Pending' : (entry.status === 'approved' ? 'Approved' : 'Selesai')}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="viewEntry(${entry.id})">Lihat</button>
                            <button class="btn btn-secondary btn-sm" onclick="editEntry(${entry.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteEntry(${entry.id})">Hapus</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Load Recent Entries (Dashboard) (Tidak perlu Jumlah Tamu di sini, disesuaikan dengan skema tabel yang ada)
        async function loadRecentEntries() {
            const tbody = document.getElementById('recentEntriesTable');
            const allData = await fetchEntriesFromServer();
            const recent = allData.slice(0, 5);

            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--color-text-muted);">Belum ada entri</td></tr>';
                return;
            }

            tbody.innerHTML = recent.map(entry => {
                // Total entri di sini bisa dihitung dari guestCount jika diperlukan, tapi saat ini hanya menampilkan entri utama
                return `
                    <tr>
                        <td>${formatDate(entry.date)}</td>
                        <td>${entry.guestName}</td>
                        <td>${entry.institution}</td>
                        <td>${entry.purpose.substring(0, 30)}${entry.purpose.length > 30 ? '...' : ''}</td>
                        <td><span class="badge badge-${entry.status}">${entry.status === 'pending' ? 'Pending' : (entry.status === 'approved' ? 'Approved' : 'Selesai')}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Update Dashboard
        async function updateDashboard() {
            const today = new Date().toDateString();
            const allData = await fetchEntriesFromServer();
           
            // Hitung total tamu (sum of guestCount) vs total entri (array length)
            const totalGuestCount = allData.reduce((sum, entry) => sum + (entry.guestCount || 1), 0);
           
            document.getElementById('totalEntries').textContent = totalGuestCount; // Menampilkan total Guest Count
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('pendingEntries').textContent = 
                allData.filter(e => e.status === 'pending').length;
            document.getElementById('todayEntries').textContent = 
                allData.filter(e => new Date(e.date).toDateString() === today).reduce((sum, entry) => sum + (entry.guestCount || 1), 0); // Total Guest Count Hari Ini
        }

        // View Entry
        async function viewEntry(id) {
            const allData = await fetchEntriesFromServer();
            const entry = allData.find(e => e.id === id);
            if (!entry) return;

            const statusText = entry.status === 'pending' ? 'Pending' : (entry.status === 'approved' ? 'Approved' : 'Selesai');
            
            const content = `
                <div style="line-height: 1.8; color: var(--color-text-muted);">
                    <p style="color: var(--color-text);"><strong>Tanggal:</strong> ${formatDate(entry.date)}</p>
                    <p style="color: var(--color-text);"><strong>Nama Tamu:</strong> ${entry.guestName}</p>
                    <p style="color: var(--color-text);"><strong>Identitas:</strong> ${entry.email}</p>
                    <p style="color: var(--color-text);"><strong>Telepon:</strong> ${entry.phone}</p>
                    <p style="color: var(--color-text);"><strong>Jumlah Tamu:</strong> ${entry.guestCount || 1}</p> <!-- Tampilkan Jumlah Tamu -->
                    <p style="color: var(--color-text);"><strong>Institusi:</strong> ${entry.institution}</p>
                    <p style="color: var(--color-text);"><strong>Bertemu Dengan:</strong> ${entry.meetWith}</p>
                    <p style="color: var(--color-text);"><strong>Status:</strong> <span class="badge badge-${entry.status}">${statusText}</span></p>
                    <p style="color: var(--color-text);"><strong>Dibuat Oleh:</strong> ${entry.userName}</p>
                    <div style="margin-top: 1rem; padding: 1rem; border: 1px solid rgba(0, 242, 255, 0.1); border-radius: 8px;">
                        <h4 style="color: var(--color-primary); margin-bottom: 0.5rem;">Keperluan Detail:</h4>
                        <p style="white-space: pre-wrap; color: var(--color-text);">${entry.purpose}</p>
                    </div>
                </div>
            `;

            document.getElementById('viewModalContent').innerHTML = content;
            document.getElementById('viewModal').classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }

        // Edit Entry
        function editEntry(id) {
            const entry = guestbookEntries.find(e => e.id === id);
            if (!entry) return;

            document.getElementById('editEntryId').value = entry.id;
            document.getElementById('editGuestName').value = entry.guestName;
            document.getElementById('editGuestEmail').value = entry.email;
            document.getElementById('editGuestPhone').value = entry.phone;
            document.getElementById('editGuestCount').value = entry.guestCount || 1; // Muat Jumlah Tamu
            document.getElementById('editGuestInstitution').value = entry.institution;
            document.getElementById('editGuestPurpose').value = entry.purpose;
            document.getElementById('editGuestMeetWith').value = entry.meetWith;

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('editEntryId').value);
            const index = guestbookEntries.findIndex(e => e.id === id);
            const newGuestCount = parseInt(document.getElementById('editGuestCount').value);

            if (newGuestCount < 1) {
                showAlert('mainAlert', 'Jumlah Tamu harus minimal 1.', 'error');
                return;
            }

            if (index !== -1) {
                guestbookEntries[index].guestName = document.getElementById('editGuestName').value;
                guestbookEntries[index].email = document.getElementById('editGuestEmail').value;
                guestbookEntries[index].phone = document.getElementById('editGuestPhone').value;
                guestbookEntries[index].guestCount = newGuestCount; // Update Jumlah Tamu
                guestbookEntries[index].institution = document.getElementById('editGuestInstitution').value;
                guestbookEntries[index].purpose = document.getElementById('editGuestPurpose').value;
                guestbookEntries[index].meetWith = document.getElementById('editGuestMeetWith').value;

                await updateEntryOnServer(guestbookEntries);
               
                await loadAllEntries();
                await loadMyEntries();
                await loadRecentEntries();
                await updateDashboard();

                closeEditModal();
                showAlert('mainAlert', 'Entri berhasil diupdate!', 'success');
            }
        });

        // Delete Entry
        function deleteEntry(id) {
            showConfirmationModal('Hapus Entri', 'Anda yakin ingin menghapus entri buku tamu ini?', async () => {
                guestbookEntries = guestbookEntries.filter(e => e.id !== id);
                await updateEntryOnServer(guestbookEntries);

                await loadAllEntries();
                await loadMyEntries();
                await loadRecentEntries();
                await updateDashboard();
                showAlert('mainAlert', 'Entri berhasil dihapus!', 'success');
            });
        }

        // Approve Entry
        function approveEntry(id) {
            const entry = guestbookEntries.find(e => e.id === id);
            if (entry) {
                showConfirmationModal('Approve Entri', `Yakin ingin menyetujui entri tamu dari ${entry.guestName}? Tamu akan berstatus 'Approved'.`, async () => {
                    entry.status = 'approved';
                    await updateEntryOnServer(guestbookEntries);

                    await loadAllEntries();
                    await updateDashboard();
                    showAlert('mainAlert', 'Entri berhasil di-approve!', 'success');
                });
            }
        }
        
        // New function: Complete Entry
        function completeEntry(id) {
            const entry = guestbookEntries.find(e => e.id === id);
            if (entry) {
                showConfirmationModal('Tandai Selesai', `Yakin tamu ${entry.guestName} sudah selesai dengan keperluannya dan keluar dari lokasi? Status akan diubah menjadi 'Selesai'.`, async () => {
                    entry.status = 'completed';
                    await updateEntryOnServer(guestbookEntries);

                    await loadAllEntries();
                    await updateDashboard();
                    showAlert('mainAlert', 'Entri berhasil ditandai Selesai!', 'info');
                });
            }
        }


        // Users Management
        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            if (!tbody || currentUser.role !== 'admin') return;

            const searchTerm = document.getElementById('searchUsers')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('filterRole')?.value || '';

            let filtered = users.filter(user => {
                const matchSearch = user.name.toLowerCase().includes(searchTerm) ||
                                         user.email.toLowerCase().includes(searchTerm);
                const matchRole = !roleFilter || user.role === roleFilter;
                return matchSearch && matchRole;
            });

            tbody.innerHTML = filtered.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td><span class="badge badge-${user.role}">${user.role === 'admin' ? 'Admin' : 'User'}</span></td>
                    <td><span class="badge badge-${user.status === 'active' ? 'approved' : 'pending'}">${user.status === 'active' ? 'Aktif' : 'Nonaktif'}</span></td>
                    <td>
                        <div class="action-btns">
                            ${user.id !== currentUser.id ? 
                                `<button class="btn btn-${user.status === 'active' ? 'warning' : 'success'} btn-sm" 
                                    onclick="toggleUserStatus(${user.id})">
                                    ${user.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}
                                </button>
                                ${user.role !== 'admin' ? 
                                    `<button class="btn btn-primary btn-sm" onclick="promoteToAdmin(${user.id})">Jadikan Admin</button>` : 
                                    `<button class="btn btn-secondary btn-sm" onclick="demoteToUser(${user.id})">Jadikan User</button>`
                                }` : '<em>Akun Anda</em>'}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                const newStatus = user.status === 'active' ? 'inactive' : 'active';
                const action = user.status === 'active' ? 'menonaktifkan' : 'mengaktifkan';
               
                showConfirmationModal('Ubah Status User', `Yakin ingin ${action} akun ${user.name}?`, async () => {
                    user.status = newStatus;
                    await updateUsersOnServer();
                    loadUsers();
                    showAlert('mainAlert', `User berhasil ${newStatus === 'active' ? 'diaktifkan' : 'dinonaktifkan'}!`, 'success');
                });
            }
        }

        function promoteToAdmin(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                showConfirmationModal('Promosikan User', `Yakin ingin menjadikan user ${user.name} sebagai admin? User akan memiliki akses penuh.`, async () => {
                    user.role = 'admin';
                    await updateUsersOnServer();
                    loadUsers();
                    showAlert('mainAlert', 'User berhasil dijadikan admin!', 'success');
                });
            }
        }

        function demoteToUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                showConfirmationModal('Turunkan Role', `Yakin ingin menurunkan role admin ${user.name} menjadi user biasa?`, async () => {
                    user.role = 'user';
                    await updateUsersOnServer();
                    loadUsers();
                    showAlert('mainAlert', 'Admin berhasil dijadikan user!', 'success');
                });
            }
            if (id === currentUser.id) {
                // Force logout if the current user demotes themselves from admin
                if (user.role === 'user') {
                    logout(); 
                    showAlert('loginAlert', 'Role Anda telah diturunkan. Anda telah logout.', 'info');
                }
            }
        }

        // Profile Settings
        function loadProfileData() {
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profilePhone').value = currentUser.phone;
            document.getElementById('profileAddress').value = currentUser.address || '';
        }

        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            currentUser.name = document.getElementById('profileName').value;
            currentUser.email = document.getElementById('profileEmail').value;
            currentUser.phone = document.getElementById('profilePhone').value;
            currentUser.address = document.getElementById('profileAddress').value;

            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = { ...currentUser };
                await updateUsersOnServer();
                localStorage.setItem('currentUserSession', JSON.stringify({ id: currentUser.id, role: currentUser.role }));
            }

            document.getElementById('navUserName').textContent = currentUser.name;
            document.getElementById('navUserAvatar').textContent = currentUser.name.charAt(0).toUpperCase();

            showAlert('mainAlert', 'Profil berhasil diupdate!', 'success');
        });

        // Password Change
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (oldPassword !== currentUser.password) {
                showAlert('mainAlert', 'Password lama tidak sesuai!', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('mainAlert', 'Konfirmasi password tidak sesuai!', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('mainAlert', 'Password minimal 6 karakter!', 'error');
                return;
            }

            currentUser.password = newPassword;
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                await updateUsersOnServer();
                localStorage.setItem('currentUserSession', JSON.stringify({ id: currentUser.id, role: currentUser.role }));
            }

            this.reset();
            showAlert('mainAlert', 'Password berhasil diubah!', 'success');
        });

        // Export Functions
        async function exportToCSV() {
            const allData = await fetchEntriesFromServer();
            // Tambahkan "Jumlah Tamu" ke header
            const headers = ['Tanggal', 'Nama Tamu', 'Identitas', 'Jumlah Tamu', 'Telepon', 'Institusi', 'Keperluan', 'Bertemu Dengan', 'Status', 'Dibuat Oleh'];
            const rows = allData.map(entry => [
                formatDate(entry.date),
                entry.guestName,
                entry.email, 
                entry.guestCount || 1, // Sertakan Jumlah Tamu
                entry.phone,
                entry.institution,
                entry.purpose.replace(/"/g, '""'),
                entry.meetWith,
                entry.status === 'completed' ? 'Selesai' : entry.status, // Perbarui status untuk CSV
                entry.userName
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `buku-tamu-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showAlert('mainAlert', 'Data berhasil di-export ke CSV!', 'success');
        }

        function exportToPDF() {
            showAlert('mainAlert', 'Fitur export PDF menggunakan fitur cetak browser. Silakan pilih "Simpan sebagai PDF" di dialog cetak.', 'info');
            setTimeout(() => {
                printEntries();
            }, 1000);
        }

        async function printEntries() {
            const allData = await fetchEntriesFromServer();
            const filteredEntries = filterAndSearchEntries(
                allData,
                document.getElementById('searchEntries').value,
                document.getElementById('filterStatus').value,
                document.getElementById('filterDate').value
            );

            const tableRows = filteredEntries.map(entry => `
                <tr>
                    <td>${formatDate(entry.date)}</td>
                    <td>${entry.guestName}</td>
                    <td>${entry.email}</td>
                    <td>${entry.guestCount || 1}</td> <!-- Sertakan Jumlah Tamu -->
                    <td>${entry.institution}</td>
                    <td>${entry.purpose.substring(0, 100)}...</td>
                    <td>${entry.status === 'pending' ? 'Pending' : (entry.status === 'approved' ? 'Approved' : 'Selesai')}</td>
                </tr>
            `).join('');

            const printWindow = window.open('', '', 'height=600,width=800');
            const content = `
                <html>
                <head>
                    <title>Buku Tamu Online - Print</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #0a0e27; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #00f2ff; color: #0a0e27; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>üìñ Buku Tamu Online</h1>
                    <p>Tanggal Cetak: ${formatDate(new Date().toISOString())}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama</th>
                                <th>Identitas</th>
                                <th>Jumlah Tamu</th> <!-- Tambah Header -->
                                <th>Institusi</th>
                                <th>Keperluan</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.print();
        }

        // Helper function for filtering (now accepts data as argument)
        function filterAndSearchEntries(data, searchTerm, statusFilter, dateFilter) {
            const searchLower = searchTerm.toLowerCase();

            return data.filter(entry => {
                const matchSearch = entry.guestName.toLowerCase().includes(searchLower) ||
                                         entry.institution.toLowerCase().includes(searchLower) ||
                                         entry.purpose.toLowerCase().includes(searchLower);
               
                let matchStatus = true;
                if (statusFilter === 'completed') {
                    matchStatus = entry.status === 'completed';
                } else if (statusFilter === 'approved') {
                    matchStatus = entry.status === 'approved';
                } else if (statusFilter === 'pending') {
                    matchStatus = entry.status === 'pending';
                }
               
                let matchDate = true;
                if (dateFilter) {
                    const entryDate = new Date(entry.date);
                    const now = new Date();
                    if (dateFilter === 'today') {
                        matchDate = entryDate.toDateString() === now.toDateString();
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchDate = entryDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        matchDate = entryDate.getMonth() === now.getMonth() && 
                                         entryDate.getFullYear() === now.getFullYear();
                    }
                }

                return matchSearch && matchStatus && matchDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Event Listeners for Search & Filter
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchEntries')?.addEventListener('input', loadAllEntries);
            document.getElementById('filterStatus')?.addEventListener('change', loadAllEntries);
            document.getElementById('filterDate')?.addEventListener('change', loadAllEntries);
            document.getElementById('searchUsers')?.addEventListener('input', loadUsers);
            document.getElementById('filterRole')?.addEventListener('change', loadUsers);
            
            // Initial call to ensure dashboard uses guestCount for totals
            updateDashboard(); 
        });

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('id-ID', options);
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;

            setTimeout(() => {
                alert.classList.remove('show');
            }, 4000);
        }

    </script>
</body>

</html>
